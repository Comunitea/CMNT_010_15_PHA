<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>
        <template id="lot_certification_and_release_report">
            <t t-call="report.html_container">
                <t t-foreach="docs" t-as="o">
                    <div class="page" style="font-size: 115%;">
                        <div class="row">
                            <div class="col-xs-3" style="margin-bottom: -20px;">
                                <img t-if="res_company.logo" t-att-src="'data:image/png;base64,%s' % res_company.logo" style="max-height: 70px;"/>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12 text-center">
                                <b style="font-size: 1.6em;">CERTIFICACIÓN Y LIBERACIÓN DE LOTE</b>
                            </div>
                        </div>

                        <!-- Producción donde se fabrica este lote -->
                        <t t-set="production" t-value="o.env['mrp.production'].search([('final_lot_id', '=', o.id)])"/>

                        <!-- Obtenemos y ordenamos los registros de producción -->
                        <t t-set="aRegProd" t-value="[]"/>
                        <t t-set="vistas" t-value="production.env['quality.protocol.report.reference'].search([('report_type_id', '=', 2)])"/> <!-- Registros producción -->
                        <t t-foreach="vistas" t-as="vista">
                            <t t-set="modelo_tabla" t-value="production.env[vista.model_id.model]"/>
                            <t t-set="ordenes" t-value="production.workcenter_lines"/>
                            <t t-set="secciones" t-value="modelo_tabla.x_section_id.search([('x_wcl_id', 'in', ordenes.ids), ('x_table_ids', '!=', False)])"/>
                            <t t-foreach="secciones" t-as="seccion">
                                <t t-foreach="seccion.x_table_ids" t-as="table_id">
                                    <t t-set="aux" t-value="aRegProd.append(table_id)"/>
                                </t>
                            </t>
                        </t>
                        <t t-set="aux" t-value="aRegProd.sort(key=lambda reg: reg.x_create_date + '_' + reg.x_init_time)"/>

                        <div class="row" style="border: 1px solid black; font-size: 1.2em;">
                            <div class="col-xs-6">
                                <b>Producto: </b><span t-field="o.product_id"/>
                            </div>
                            <div class="col-xs-3" style="border-right: 1px solid black; padding-bottom: 0.25em;">
                                <span t-field="o.product_id.default_code"/><br/>
                                <t t-set="barcode" t-value="o.product_id.default_code"/>
                                <t t-set="barcode" t-value="barcode.replace('-', '/')"/>
                                <div style="width: 100%; overflow: hidden;">
                                    <img style="margin-left: -45px;"
                                             t-att-src="'/report/barcode/?type=%s&amp;value=%s&amp;width=%s&amp;height=%s'%('Code128', barcode, 1200, 200)"
                                             height="30" width="280"/>
                                </div>
                            </div>
                            <div class="col-xs-3" style="padding-bottom: 0.25em;">
                                <b>Nº lote: </b><span t-field="o.name"/><br/>
                                <t t-set="barcode" t-value="o.name"/>
                                <t t-set="barcode" t-value="barcode.replace('-', '/')"/>
                                <div style="width: 100%; overflow: hidden;">
                                    <img style="margin-left: -45px;"
                                             t-att-src="'/report/barcode/?type=%s&amp;value=%s&amp;width=%s&amp;height=%s'%('Code128', barcode, 1200, 200)"
                                             height="30" width="280"/>
                                </div>
                            </div>
                        </div>

                        <div class="row" style="border: 1px solid black; border-top: 0;">
                            <div class="col-xs-9" style="border: 1px solid black; border-top: 0; border-left: 0;">
                                <div class="col-xs-4">
                                    <b>Fecha de fabricación</b>
                                </div>
                                <div class="col-xs-2">
                                    <b>Inicio:</b>
                                </div>
                                <div class="col-xs-3">
                                    <t t-if="aRegProd">
                                        <span t-field="aRegProd[0].x_create_date"/>
                                    </t>
                                </div>
                                <div class="col-xs-2">
                                    <t t-if="aRegProd">
                                        <span t-field="aRegProd[0].x_init_time"/>
                                    </t>
                                </div>
                            </div>

                            <!-- Obtenemos los campos de unidades fabricadas -->
                            <t t-set="unidadesFabricadas" t-value="[]"/>
                            <t t-set="vistas" t-value="production.env['quality.protocol.report.reference'].search([('report_type_id', '=', 6)])"/> <!-- Unidades fabricadas -->
                            <t t-foreach="vistas" t-as="vista">
                                <t t-set="modelo_tabla" t-value="production.env[vista.model_id.model]"/>
                                <t t-set="ordenes" t-value="production.workcenter_lines"/>
                                <t t-set="tablas" t-value="modelo_tabla.search([('x_wcl_id', 'in', ordenes.ids)])"/>
                                <t t-foreach="tablas" t-as="table_id">
                                    <t t-set="aux" t-value="unidadesFabricadas.append(table_id[vista.data_reference])"/>
                                </t>
                            </t>

                            <!-- Obtenemos los campos de peso final obtenido -->
                            <t t-set="pesosFinalesObtenidos" t-value="[]"/>
                            <t t-set="vistas" t-value="production.env['quality.protocol.report.reference'].search([('report_type_id', '=', 7)])"/> <!-- Peso final obtenido -->
                            <t t-foreach="vistas" t-as="vista">
                                <t t-set="modelo_tabla" t-value="production.env[vista.model_id.model]"/>
                                <t t-set="ordenes" t-value="production.workcenter_lines"/>
                                <t t-set="tablas" t-value="modelo_tabla.search([('x_wcl_id', 'in', ordenes.ids)])"/>
                                <t t-foreach="tablas" t-as="table_id">
                                    <t t-set="aux" t-value="pesosFinalesObtenidos.append(table_id[vista.data_reference])"/>
                                </t>
                            </t>

                            <div class="col-xs-3">
                                <t t-if="unidadesFabricadas and max(unidadesFabricadas) != 0">
                                    <b>Unidades: </b><span t-esc="'{0:g}'.format(max(unidadesFabricadas))"/>
                                </t>
                                <t t-if="pesosFinalesObtenidos and max(pesosFinalesObtenidos) != 0">
                                    <b>Peso (g): </b><span t-esc="'{0:g}'.format(max(pesosFinalesObtenidos))"/>
                                </t>
                            </div>

                            <div class="col-xs-9" style="border-right: 1px solid black;">
                                <div class="col-xs-4"> </div>
                                <div class="col-xs-2">
                                    <b>Fin:</b>
                                </div>
                                <div class="col-xs-3">
                                    <t t-if="aRegProd">
                                        <span t-field="aRegProd[-1].x_create_date"/>
                                    </t>
                                </div>
                                <div class="col-xs-2">
                                    <t t-if="aRegProd">
                                        <span t-field="aRegProd[-1].x_end_time"/>
                                    </t>
                                </div>
                            </div>
                            <div class="col-xs-3"><![CDATA[&nbsp;]]></div>

                            <div class="col-xs-12" style="border-top: 1px solid black;">
                                <div class="col-xs-12" style="font-weight: bold;">Informe de trazabilidad:</div>
                                <table>
                                    <tr style="font-size: 0.9em; font-weight: bold;">
                                        <td style="width: 40%;">Material</td>
                                        <td style="width: 12%;">Lote</td>
                                        <td style="width: 8%;">Cantidad</td>
                                        <td style="width: 30%;">Proveedor</td>
                                        <td style="width: 10%; text-align: right;">F. Aceptado</td>
                                    </tr>
                                    <t t-foreach="production.move_lines2" t-as="material">
                                        <tr style="font-size: 0.8em;">
                                            <td>
                                                <span t-field="material.product_id"/>
                                            </td>
                                            <td>
                                                <span t-field="material.lot_str"/>
                                            </td>
                                            <td style="text-align: right; padding-right: 1em;">
                                                <span t-field="material.product_qty"/>
                                            </td>
                                            <td>
                                                <t t-if="material.lot_ids">
                                                    <t t-foreach="material.lot_ids[0]" t-as="lot">
                                                        <t t-set="move_ids" t-value="lot.move_related_ids.filtered(lambda r: r.picking_id.picking_type_id.id == 1 and r.picking_id.state == 'done')"/>
                                                        <t t-set="supplier" t-value="move_ids[0].picking_id.partner_id.display_name if move_ids else ''"/>
                                                        <span t-esc="supplier"/>
                                                    </t>
                                                </t>
                                            </td>
                                            <td style="text-align: right;">
                                                <t t-if="material.lot_ids">
                                                    <span t-field="material.lot_ids[0].acceptance_date"/>
                                                </t>
                                            </td>
                                        </tr>
                                    </t>
                                </table>
                            </div>
                        </div>

                        <div class="row" style="margin-top: 0.5em;">
                            <div class="col-xs-12"><b>REVISIÓN PRODUCCIÓN</b></div>
                            <div class="col-xs-12" style="border: 1px solid black;">
                                <div class="row">
                                    <div class="col-xs-6">Conforme:</div>
                                    <div class="col-xs-2">SÍ</div>
                                    <div class="col-xs-2">NO</div>
                                    <div class="col-xs-2"><![CDATA[&nbsp;]]></div>
                                </div>
                                <t t-foreach="o.production_review_ids" t-as="pr">
                                    <div class="row">
                                        <div class="col-xs-6" style="padding-left: 2em;"><![CDATA[&#9679;]]> <span t-esc="pr.question_id.name"/></div>
                                        <div class="col-xs-2" t-esc="'&#9745;' if pr.result == 'yes' else '&#9744;'"/>
                                        <div class="col-xs-2" t-esc="'&#9745;' if pr.result == 'no' else '&#9744;'"/>
                                        <div class="col-xs-2"><![CDATA[&nbsp;]]></div>
                                    </div>
                                </t>
                            </div>
                            <div class="col-xs-12" style="border: 1px solid black; border-top: 0; min-height: 2.5em;">
                                <div class="col-xs-8">
                                    NOTAS:<br/>
                                    <span t-field="o.production_review_notes"/>
                                </div>
                                <div class="col-xs-4">
                                    Revisado por:<br/>
                                    <div class="col-xs-8" t-field="o.production_review_done_by"/>
                                    <div class="col-xs-4" t-field="o.production_review_date"/>
                                </div>
                            </div>
                        </div>

                        <div class="row" style="margin-top: 0.5em;">
                            <div class="col-xs-12"><b>REVISIÓN CONTROL CALIDAD</b></div>
                            <div class="col-xs-12" style="border: 1px solid black;">
                                <div class="row">
                                    <div class="col-xs-6">Conforme:</div>
                                    <div class="col-xs-2">SÍ</div>
                                    <div class="col-xs-2">NO</div>
                                    <div class="col-xs-2">N/A</div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-6" style="padding-left: 2em;"><![CDATA[&#9679;]]> Control materiales de partida</div>
                                    <t t-set="analysis" t-value="o.analysis_ids.filtered(lambda r: r.analysis_id.id == 372)"/>
                                    <div class="col-xs-2" t-esc="'&#9745;' if analysis.passed else '&#9744;'"/>
                                    <div class="col-xs-2" t-esc="'&#9744;' if analysis.passed else '&#9745;'"/>
                                    <div class="col-xs-2" t-esc="'&#9744;' if analysis.realized else '&#9745;'"/>
                                </div>
                                <div class="row">
                                    <div class="col-xs-6" style="padding-left: 2em;"><![CDATA[&#9679;]]> Controles en proceso</div>
                                    <t t-set="analysis" t-value="o.analysis_ids.filtered(lambda r: r.analysis_id.id == 374)"/>
                                    <div class="col-xs-2" t-esc="'&#9745;' if analysis.passed else '&#9744;'"/>
                                    <div class="col-xs-2" t-esc="'&#9744;' if analysis.passed else '&#9745;'"/>
                                    <div class="col-xs-2" t-esc="'&#9744;' if analysis.realized else '&#9745;'"/>
                                </div>
                                <div class="row">
                                    <div class="col-xs-6" style="padding-left: 2em;"><![CDATA[&#9679;]]> Controles analíticos producto final</div>
                                    <t t-set="analysis" t-value="o.analysis_ids.filtered(lambda r: r.analysis_id.id == 373)"/>
                                    <div class="col-xs-2" t-esc="'&#9745;' if analysis.passed else '&#9744;'"/>
                                    <div class="col-xs-2" t-esc="'&#9744;' if analysis.passed else '&#9745;'"/>
                                    <div class="col-xs-2" t-esc="'&#9744;' if analysis.realized else '&#9745;'"/>
                                </div>
                            </div>
                            <div class="col-xs-12" style="border: 1px solid black; border-top: 0; min-height: 2.5em;">
                                <div class="col-xs-8">
                                    NOTAS:<br/>
                                    <span t-field="o.analysis_notes"/>
                                </div>
                                <div class="col-xs-4">
                                    Revisado por:<br/>
                                    <div class="col-xs-8" t-field="o.revised_by"/>
                                    <div class="col-xs-4" t-field="o.sampling_date"/> <!-- No hay fecha de "Revisado por" de los análisis -->
                                </div>
                            </div>
                        </div>

                        <div class="row" style="margin-top: 0.5em;">
                            <div class="col-xs-12"><b>REVISIÓN DIRECCIÓN TÉCNICA</b></div>
                            <div class="col-xs-12" style="border: 1px solid black;">
                                <div class="row">
                                    <div class="col-xs-6">Conforme:</div>
                                    <div class="col-xs-2">SÍ</div>
                                    <div class="col-xs-2">NO</div>
                                    <div class="col-xs-2">N/A</div>
                                </div>
                                <t t-foreach="o.technical_direction_review_ids" t-as="td">
                                    <div class="row">
                                        <div class="col-xs-6" style="padding-left: 2em;"><![CDATA[&#9679;]]> <span t-esc="td.question_id.name"/></div>
                                        <div class="col-xs-2" t-esc="'&#9745;' if td.result == 'yes' else '&#9744;'"/>
                                        <div class="col-xs-2" t-esc="'&#9745;' if td.result == 'no' else '&#9744;'"/>
                                        <div class="col-xs-2" t-esc="'&#9745;' if td.result == 'na' else '&#9744;'"/>
                                    </div>
                                </t>
                            </div>
                            <div class="col-xs-12" style="border: 1px solid black; border-top: 0; min-height: 2.5em;">
                                <div class="col-xs-8">
                                    NOTAS:<br/>
                                    <span t-field="o.technical_direction_review_notes"/>
                                </div>
                                <div class="col-xs-4">
                                    Revisado por:<br/>
                                    <div class="col-xs-8" t-field="o.technical_direction_review_done_by"/>
                                    <div class="col-xs-4" t-field="o.technical_direction_review_date"/>
                                </div>
                            </div>
                        </div>

                        <div class="row" style="text-align: left; padding: 0;">
                            <div style="display: inline-block; page-break-inside: avoid; border: 8px double black; padding: 5px 5px 0 5px; margin-top: 15px; width: 50%;">
                                <h4>
                                    <table t-if="o.detail_ids" class="table table-condensed">
                                        <tbody>
                                            <t t-foreach="o.detail_ids" t-as="detail">
                                                <tr>
                                                    <td style="padding: 1px; border: 0;"><span t-field="detail.date"/></td>
                                                    <td style="padding: 1px; border: 0;"><b t-field="detail.state"/></td>
                                                    <td style="padding: 1px; border: 0;"><span t-esc="'{0:g}'.format(detail.quantity)"/> <span t-field="o.product_id.uom_id"/></td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                    <table t-if="not o.detail_ids" class="table table-condensed">
                                        <tbody>
                                            <tr>
                                                <td style="padding: 1px; border: 0;"><span t-field="o.acceptance_date"/></td>
                                                <td style="padding: 1px; border: 0;"><b t-field="o.state"/></td>

                                                <t t-set="quantity" t-value="0"/>
                                                <t t-foreach="o.quant_ids" t-as="q">
                                                    <t t-set="quantity" t-value="quantity + q.qty"/>
                                                </t>
                                                <td style="padding: 1px; border: 0;"><span t-esc="'{0:g}'.format(quantity)"/> <span t-field="o.product_id.uom_id"/></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </h4>
                            </div>
                        </div>
                    </div>
                </t>
            </t>
        </template>
    </data>
</openerp>